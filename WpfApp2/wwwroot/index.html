<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendar · WebView2 + shadcn-inspired</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #0b1220;
      --card: rgba(255, 255, 255, 0.04);
      --muted: #8ea1c7;
      --text: #e6ecfb;
      --primary: #7c3aed;
      --primary-strong: #a855f7;
      --accent: #22d3ee;
      --border: rgba(255, 255, 255, 0.08);
      --shadow: 0 25px 80px rgba(0, 0, 0, 0.45), 0 10px 35px rgba(0, 0, 0, 0.35);
      --radius: 18px;
      --transition: 200ms ease;
      --font-sans: "Segoe UI Variable", "Segoe UI", "Noto Sans", sans-serif;
      --font-mono: "Cascadia Code", "Cascadia Mono", "Consolas", monospace;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-sans);
      background: radial-gradient(circle at 20% 20%, rgba(124, 58, 237, 0.2), transparent 25%),
                  radial-gradient(circle at 80% 0%, rgba(34, 211, 238, 0.25), transparent 30%),
                  linear-gradient(135deg, #0b1220 0%, #0b1220 40%, #0f172a 100%);
      color: var(--text);
      display: grid;
      place-items: center;
      padding: 32px;
    }

    .shell {
      width: min(1100px, 100%);
      display: grid;
      grid-template-columns: 1.3fr 0.7fr;
      gap: 18px;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.01));
      border: 1px solid var(--border);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      padding: 20px;
    }

    @media (max-width: 900px) {
      body { padding: 18px; }
      .shell { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(124, 58, 237, 0.12);
      border: 1px solid rgba(124, 58, 237, 0.3);
      color: #d6bcff;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      font-size: 11px;
    }

    .subtitle {
      color: var(--muted);
      margin: 4px 0 0;
      font-size: 14px;
    }

    .controls {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.02);
      padding: 6px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    button {
      appearance: none;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform var(--transition), border-color var(--transition), background var(--transition), color var(--transition);
      font-weight: 600;
    }

    button:hover {
      transform: translateY(-1px);
      border-color: rgba(255, 255, 255, 0.2);
      background: rgba(124, 58, 237, 0.1);
    }

    button.primary {
      background: transparent;
      border-color: transparent;
      color: var(--text);
      box-shadow: none;
    }

    button.ghost {
      background: transparent;
      border-color: transparent;
      color: var(--muted);
    }

    .icon {
      width: 18px;
      height: 18px;
      object-fit: contain;
      display: block;
    }

    .icon-invert { filter: brightness(0) invert(1); }

    .icon-text {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .menu-button {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 8px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      border: 1px solid var(--border);
      cursor: pointer;
    }

    .header-bar {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding-top: 8px;
    }

    .calendar {
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 32px;
    }

    .month-header {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 0 14px;
    }

    .month-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 0.01em;
      text-align: center;
    }

    .year {
      color: var(--muted);
      font-size: 14px;
      margin-left: 6px;
    }

    .month-title-wrap {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .header-actions {
      position: absolute;
      right: 0;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .weekday-row, .day-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 8px;
    }

    .weekday {
      text-align: center;
      color: var(--muted);
      font-weight: 600;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .day {
      position: relative;
      min-height: 84px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.02);
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: transform var(--transition), border-color var(--transition), background var(--transition), box-shadow var(--transition);
    }

    .day:hover {
      transform: translateY(-2px);
      border-color: rgba(124, 58, 237, 0.35);
      background: rgba(255, 255, 255, 0.04);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
    }

    .day.outside { opacity: 0.32; }
    .day.today { border-color: rgba(34, 211, 238, 0.45); box-shadow: 0 0 0 1px rgba(34, 211, 238, 0.4); }
    .day.selected { border-color: rgba(124, 58, 237, 0.6); background: linear-gradient(145deg, rgba(124, 58, 237, 0.16), rgba(124, 58, 237, 0.06)); }
    .day.first-of-month { /* reset to normal style (no special border) */ }

    .day-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      font-weight: 700;
      font-size: 14px;
    }

    .day.selected .day-number { background: rgba(124, 58, 237, 0.2); color: #e9d5ff; }
    .day.today .day-number { background: rgba(34, 211, 238, 0.15); color: #b5f3ff; }

    .badge {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 4px 4px;
      min-height: 8px;
      max-width: 100%;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22d3ee;
      flex-shrink: 0;
    }

    .dot.more {
      width: auto;
      height: auto;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(34, 211, 238, 0.15);
      color: #99f6ff;
      font-size: 11px;
      font-weight: 700;
      line-height: 1;
    }

    .event-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .event {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
    }

    .event-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(34, 211, 238, 0.12);
    }

    .event-main { flex: 1; }
    .event-title { font-weight: 700; }
    .event-time { color: var(--muted); font-size: 12px; }
    .event-meta {
      color: var(--muted);
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }

    .event-actions {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .icon-btn {
      background: transparent;
      border: none;
      padding: 4px;
      cursor: pointer;
      border-radius: 8px;
      transition: background var(--transition);
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.06);
    }

    .action-menu {
      display: none;
      align-items: center;
      gap: 4px;
    }

    .action-menu.open { display: inline-flex; }

    .hidden { display: none !important; }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }

    .modal-card {
      width: min(420px, 100%);
      background: #0f172a;
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 700;
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
    }

    /* Date picker icon to white for dark background */
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
      opacity: 0.8;
    }
    input[type="date"]::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 4px;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-strong));
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #f7f4ff;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(124, 58, 237, 0.25);
    }

    .modal-body p { margin: 0; color: var(--muted); }

    .panel-title {
      font-size: 16px;
      font-weight: 700;
      margin: 0 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .progress {
      height: 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }

    .progress > div {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      width: 0;
      transition: width 350ms ease;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px dashed var(--border);
      color: var(--muted);
      font-size: 12px;
    }

    .kpi {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: 0.01em;
    }

    .kpi-sub { color: var(--muted); font-size: 13px; }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card calendar">
      <div class="month-header">
        <button class="menu-button" aria-label="Menu">
          <img src="./assets/menu.png" class="icon" alt="Menu" />
        </button>

        <div class="month-title-wrap">
          <button id="prevMonth" aria-label="Previous month">
            <img src="./assets/chevron-left.png" class="icon" alt="Previous" />
          </button>
          <div class="month-title" id="monthLabel"></div>
          <button id="nextMonth" aria-label="Next month">
            <img src="./assets/chevron-right.png" class="icon" alt="Next" />
          </button>
        </div>

        <div class="header-actions">
          <button id="syncBtn" class="ghost" title="동기화">
            <img src="./assets/calendar-sync.png" class="icon icon-invert" alt="Sync" />
          </button>
          <button id="todayBtn" class="ghost">Today</button>
          <button id="newEvent" class="primary">
            <span class="icon-text">
              <img src="./assets/calendar-plus.png" class="icon" alt="Add" />
            </span>
          </button>
        </div>
      </div>

      <div class="weekday-row" id="weekdayRow"></div>
      <div class="day-grid" id="dayGrid"></div>
    </div>

    <div class="card">
      <p class="panel-title" id="sidebarTitle">일정</p>
      <div id="eventList" class="event-list"></div>
    </div>
  </div>

  <!-- Modal for create/edit -->
  <div id="modalBackdrop" class="modal-backdrop hidden">
    <div id="modalEvent" class="modal-card">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">일정 추가</div>
        <button class="icon-btn" id="modalClose" aria-label="Close">
          <img src="./assets/x.png" class="icon" alt="Close" />
        </button>
      </div>
      <form id="modalForm" class="modal-form">
        <input type="hidden" id="inputEventId" />
        <label>
          <div class="kpi-sub">제목</div>
          <input id="inputTitle" class="input" type="text" required placeholder="제목을 입력하세요" />
        </label>
        <label>
          <div class="kpi-sub" style="display:flex; align-items:center; gap:6px;">
            <img src="./assets/calendar-days.png" class="icon" alt="date" />
            <span>시작</span>
          </div>
          <div style="display:flex; gap:8px;">
            <input id="inputStartDate" class="input" style="flex:1;" type="date" />
            <input id="inputTime" class="input" style="width:120px;" type="text" placeholder="예: 08:00" />
          </div>
        </label>
        <label>
          <div class="kpi-sub" style="display:flex; align-items:center; gap:6px;">
            <img src="./assets/calendar-days.png" class="icon" alt="date" />
            <span>종료</span>
          </div>
          <div style="display:flex; gap:8px;">
            <input id="inputEndDate" class="input" style="flex:1;" type="date" />
            <input id="inputEndTime" class="input" style="width:120px;" type="text" placeholder="예: 09:00" />
          </div>
        </label>
        <label style="display:flex; align-items:center; gap:8px;">
          <input id="inputAllDay" type="checkbox" />
          <span class="kpi-sub">하루종일</span>
        </label>
        <label>
          <div class="kpi-sub" style="display:flex; align-items:center; gap:6px;">
            <img src="./assets/map-pin.png" class="icon" alt="location" />
            <span>위치</span>
          </div>
          <input id="inputLocation" class="input" type="text" placeholder="장소를 입력하세요" />
        </label>
        <label>
          <div class="kpi-sub" style="display:flex; align-items:center; gap:6px;">
            <img src="./assets/bell.png" class="icon" alt="reminder" />
            <span>알림 (분)</span>
          </div>
          <input id="inputReminder" class="input" type="number" min="0" step="5" placeholder="예: 30 (분 전)" />
        </label>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" id="modalCancel">취소</button>
          <button type="submit" class="btn-primary" id="modalSubmit">저장</button>
        </div>
      </form>
    </div>

    <div id="modalDelete" class="modal-card hidden">
      <div class="modal-header">
        <div class="modal-title">일정 삭제</div>
        <button class="icon-btn" id="deleteClose" aria-label="Close">
          <img src="./assets/x.png" class="icon" alt="Close" />
        </button>
      </div>
      <div class="modal-body">
        <p id="deleteText"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" id="deleteCancel">취소</button>
        <button type="button" class="btn-primary" id="deleteConfirm">삭제</button>
      </div>
    </div>
  </div>

  <script>
    const weekdayRow = document.getElementById("weekdayRow");
    const dayGrid = document.getElementById("dayGrid");
    const monthLabel = document.getElementById("monthLabel");
    const eventList = document.getElementById("eventList");
    const sidebarTitle = document.getElementById("sidebarTitle");
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalEvent = document.getElementById("modalEvent");
    const modalDelete = document.getElementById("modalDelete");
    const modalTitleEl = document.getElementById("modalTitle");
    const modalForm = document.getElementById("modalForm");
    const inputEventId = document.getElementById("inputEventId");
    const inputStartDate = document.getElementById("inputStartDate");
    const inputEndDate = document.getElementById("inputEndDate");
    const inputTitle = document.getElementById("inputTitle");
    const inputTime = document.getElementById("inputTime");
    const inputEndTime = document.getElementById("inputEndTime");
    const inputAllDay = document.getElementById("inputAllDay");
    const modalCancel = document.getElementById("modalCancel");
    const modalClose = document.getElementById("modalClose");
    const deleteClose = document.getElementById("deleteClose");
    const deleteCancel = document.getElementById("deleteCancel");
    const deleteConfirm = document.getElementById("deleteConfirm");
    const deleteText = document.getElementById("deleteText");
    const inputLocation = document.getElementById("inputLocation");
    const inputReminder = document.getElementById("inputReminder");
    const syncBtn = document.getElementById("syncBtn");

    let events = {};
    let modalState = { mode: "create", id: null, dateKey: null, endDateKey: null, allDay: false };

    const weekdayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

    const state = {
      current: new Date(),
      selected: null,
      selectedKey: null
    };

    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function parseDateKey(key) {
      const [y, m, d] = key.split("-").map(Number);
      return new Date(y, (m || 1) - 1, d || 1);
    }

    function formatDateLabel(key) {
      const d = parseDateKey(key);
      const weekdayNames = ["일", "월", "화", "수", "목", "금", "토"];
      return `${key}(${weekdayNames[d.getDay()]})`;
    }

    function buildRange(evt, startKey) {
      const endKey = evt.endDateKey || startKey;
      const isAllDay = !!evt.allDay;
      const startLabel = formatDateLabel(startKey);
      const endLabel = formatDateLabel(endKey);
      if (isAllDay) {
        if (startKey === endKey) return `${startLabel} · 하루종일`;
        return `${startLabel} → ${endLabel} · 하루종일`;
      }
      const startTime = evt.startTime || evt.time || "All day";
      const endTime = evt.endTime || startTime;
      if (startKey === endKey) return `${startLabel} · ${startTime} - ${endTime}`;
      return `${startLabel} ${startTime} → ${endLabel} ${endTime}`;
    }

    function setDateValue(input, key) {
      if (!input) return;
      try {
        const str = key || "";
        input.value = str;
        // Avoid using valueAsDate to prevent timezone shifts; keep raw yyyy-MM-dd string
      } catch {
        input.value = key;
      }
    }

    function openEventModal({ mode, id = null, title = "", time = "", endTime = "", dateKey, endDateKey = null, allDay = false, location = "", reminderMinutes = "" }) {
      const todayKey = formatDateKey(new Date());
      modalState = { mode, id, dateKey: dateKey || todayKey, endDateKey: endDateKey || dateKey || todayKey, allDay };
      modalTitleEl.textContent = mode === "create" ? "일정 추가" : "일정 수정";
      const startKey = dateKey || todayKey;
      const endKey = endDateKey || startKey;
      inputEventId.value = id || "";
      setDateValue(inputStartDate, startKey);
      setDateValue(inputEndDate, endKey);
      inputTitle.value = title;
      inputTime.value = time || "09:00";
      inputEndTime.value = endTime || "22:00";
      inputAllDay.checked = !!allDay;
      inputLocation.value = location || "";
      inputReminder.value = reminderMinutes ?? "";
      toggleTimeInputs();
      modalEvent.classList.remove("hidden");
      modalDelete.classList.add("hidden");
      modalBackdrop.classList.remove("hidden");
      inputTitle.focus();
    }

    function openDeleteModal({ id, title }) {
      modalState = { mode: "delete", id };
      deleteText.textContent = `"${title}" 일정을 삭제할까요?`;
      modalEvent.classList.add("hidden");
      modalDelete.classList.remove("hidden");
      modalBackdrop.classList.remove("hidden");
    }

    function closeModal() {
      modalBackdrop.classList.add("hidden");
    }

    function toggleTimeInputs() {
      const isAllDay = inputAllDay.checked;
      inputTime.disabled = isAllDay;
      inputEndTime.disabled = isAllDay;
      if (isAllDay) {
        inputTime.value = "";
        inputEndTime.value = "";
      }
    }

    function renderWeekdays() {
      weekdayRow.innerHTML = weekdayNames
        .map(name => `<div class="weekday">${name}</div>`)
        .join("");
    }

    let actionMenuId = 0;

    function createEventRow(evt, dateKey) {
      const row = document.createElement("div");
      row.className = "event";
      const id = `menu-${actionMenuId++}`;
      const eventId = evt.id || `${dateKey}-${evt.title}-${evt.time}`;
      const range = buildRange(evt, dateKey);
      const hasLocation = !!evt.location;
      const hasReminder = evt.reminderMinutes !== undefined && evt.reminderMinutes !== null && evt.reminderMinutes !== "";
      row.innerHTML = `
        <div class="event-color" style="background:${evt.color}"></div>
        <div class="event-main">
          <div class="event-title">${evt.title}</div>
          <div class="event-time">${range}</div>
          ${hasLocation ? `<div class="event-meta"><img src="./assets/map-pin.png" class="icon" alt="" />${evt.location}</div>` : ""}
          ${hasReminder ? `<div class="event-meta"><img src="./assets/bell.png" class="icon" alt="" />${evt.reminderMinutes}분 전</div>` : ""}
        </div>
        <div class="event-actions">
          <button class="icon-btn ellipsis-btn" data-menu="${id}" aria-label="Actions">
            <img src="./assets/ellipsis.png" class="icon" alt="More" />
          </button>
          <div class="action-menu" id="${id}">
            <button class="icon-btn edit-btn"
                    data-id="${eventId}"
                    data-date="${dateKey}"
                    data-end-date="${evt.endDateKey || dateKey}"
                    data-time="${evt.startTime || evt.time || ''}"
                    data-end-time="${evt.endTime || ''}"
                    data-all-day="${evt.allDay ? "1" : "0"}"
                    data-title="${evt.title}"
                    data-location="${evt.location || ''}"
                    data-reminder="${evt.reminderMinutes ?? ''}"
                    aria-label="Edit">
              <img src="./assets/pencil.png" class="icon" alt="Edit" />
            </button>
            <button class="icon-btn delete-btn" data-id="${eventId}" aria-label="Delete">
              <img src="./assets/trash.png" class="icon" alt="Delete" />
            </button>
          </div>
        </div>`;
      return row;
    }

    function attachActionMenus() {
      const menus = document.querySelectorAll(".action-menu");
      const buttons = document.querySelectorAll(".ellipsis-btn");
      buttons.forEach(btn => {
        btn.onclick = () => {
          const targetId = btn.getAttribute("data-menu");
          menus.forEach(m => {
            if (m.id === targetId) {
              m.classList.toggle("open");
            } else {
              m.classList.remove("open");
            }
          });
        };
      });
      document.addEventListener("click", (e) => {
        if (!(e.target.closest && e.target.closest(".event-actions"))) {
          menus.forEach(m => m.classList.remove("open"));
        }
      }, { once: true });

      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute("data-id");
          const date = btn.getAttribute("data-date");
          const endDate = btn.getAttribute("data-end-date") || date;
          const currentTitle = btn.getAttribute("data-title");
          const currentTime = btn.getAttribute("data-time");
          const currentEndTime = btn.getAttribute("data-end-time");
          const allDay = btn.getAttribute("data-all-day") === "1";
          openEventModal({
            mode: "edit",
            id,
            dateKey: date,
            endDateKey: endDate,
            title: currentTitle,
            time: currentTime,
            endTime: currentEndTime,
            allDay,
            location: btn.getAttribute("data-location") || "",
            reminderMinutes: btn.getAttribute("data-reminder") || ""
          });
        };
      });

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute("data-id");
          const title = btn.closest(".event")?.querySelector(".event-title")?.textContent || "이 일정";
          openDeleteModal({ id, title });
        };
      });
    }

    function renderEventsSidebar(dateKey, viewDate) {
      eventList.innerHTML = "";
      const todaysEvents = events[dateKey] || [];
      sidebarTitle.textContent = "일정";

      const renderGroup = (label, items) => {
        if (!items.length) return;
        const header = document.createElement("div");
        header.className = "chip";
        header.textContent = label;
        eventList.appendChild(header);

        items.forEach(evts => {
          (Array.isArray(evts) ? evts : [evts]).forEach(evt => {
            eventList.appendChild(createEventRow(evt, dateKey));
          });
        });
      };

      renderGroup("Selected day", todaysEvents);

      attachActionMenus();
    }

    function renderCalendar() {
      const viewDate = new Date(state.current);
      viewDate.setDate(1);
      const firstDay = viewDate.getDay();
      const month = viewDate.getMonth();
      const year = viewDate.getFullYear();

      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const daysInPrevMonth = new Date(year, month, 0).getDate();
      const todayKey = formatDateKey(new Date());
      monthLabel.innerHTML = `${viewDate.toLocaleString("default", { month: "long" })}<span class="year">${year}</span>`;

      const cells = [];
      for (let i = firstDay - 1; i >= 0; i--) {
        const dayNum = daysInPrevMonth - i;
        const date = new Date(year, month - 1, dayNum);
        cells.push({ date, outside: true });
      }

      for (let i = 1; i <= daysInMonth; i++) {
        const date = new Date(year, month, i);
        cells.push({ date, outside: false });
      }

      while (cells.length % 7 !== 0) {
        const date = new Date(year, month + 1, cells.length - daysInMonth - firstDay + 1);
        cells.push({ date, outside: true });
      }

      dayGrid.innerHTML = cells
        .map(cell => {
          const key = formatDateKey(cell.date);
          const isToday = key === todayKey;
          const isSelected = state.selected && formatDateKey(state.selected) === key;
          const hasEvents = events[key];
          const isFirst = cell.date.getDate() === 1;
          let badges = "";
          if (hasEvents) {
            const dots = events[key]
              .map(() => `<span class="dot"></span>`)
              .join("");
            badges = `<div class="badge">${dots}</div>`;
          }
          return `
            <div class="day ${cell.outside ? "outside" : ""} ${isToday ? "today" : ""} ${isSelected ? "selected" : ""} ${isFirst ? "first-of-month" : ""}" data-date="${key}">
              <div class="day-number">${cell.date.getDate()}</div>
              ${badges}
            </div>`;
        })
        .join("");

      dayGrid.querySelectorAll(".day").forEach(dayEl => {
        dayEl.addEventListener("click", () => {
          state.selected = parseDateKey(dayEl.dataset.date);
          state.selectedKey = dayEl.dataset.date;
          renderCalendar();
          renderEventsSidebar(dayEl.dataset.date, state.current);
        });
      });

      const selectedKey = state.selected ? formatDateKey(state.selected) : todayKey;
      if (!state.selectedKey && state.selected) state.selectedKey = selectedKey;
      renderEventsSidebar(selectedKey, viewDate);
    }

    document.getElementById("prevMonth").addEventListener("click", () => {
      state.current.setMonth(state.current.getMonth() - 1);
      renderCalendar();
      ensureRangeForView();
    });

    document.getElementById("nextMonth").addEventListener("click", () => {
      state.current.setMonth(state.current.getMonth() + 1);
      renderCalendar();
    });

    document.getElementById("todayBtn").addEventListener("click", () => {
      state.current = new Date();
      state.selected = new Date();
      state.selectedKey = formatDateKey(state.selected);
      renderCalendar();
    });

    document.getElementById("newEvent").addEventListener("click", () => {
      const key = state.selectedKey || formatDateKey(state.selected || new Date());
      openEventModal({ mode: "create", dateKey: key });
    });

    syncBtn.addEventListener("click", () => {
      if (window.chrome?.webview?.postMessage) {
        window.chrome.webview.postMessage({ kind: "sync" });
      } else {
        renderCalendar();
      }
    });

    function ensureRangeForView() {
      if (!window.chrome?.webview?.postMessage) return;
      const start = new Date(state.current.getFullYear(), state.current.getMonth(), 1);
      const key = formatDateKey(start);
      window.chrome.webview.postMessage({ kind: "ensureRange", from: key });
    }

    // Receive events from the host (WPF) via WebView2 postMessage
    window.chrome?.webview?.addEventListener("message", (event) => {
      const data = event.data;
      if (!data || data.kind !== "events" || !Array.isArray(data.items)) return;
      const nextEvents = {};
      data.items.forEach(item => {
        const key = item.startDateKey || item.dateKey;
        if (!key) return;
        nextEvents[key] = nextEvents[key] || [];
        nextEvents[key].push({
          id: item.id || `${key}-${item.title}-${item.time}`,
          title: item.title || "Event",
          startDateKey: key,
          endDateKey: item.endDateKey || key,
          startTime: item.startTime || item.time || "",
          endTime: item.endTime || "",
          allDay: item.allDay || false,
          location: item.location || "",
          reminderMinutes: item.reminderMinutes,
          color: "#22d3ee"
        });
      });
      events = nextEvents;
      renderCalendar();
      const selectedKey = state.selected ? formatDateKey(state.selected) : formatDateKey(new Date());
      renderEventsSidebar(selectedKey, state.current);
    });

    modalCancel.addEventListener("click", closeModal);
    modalClose.addEventListener("click", closeModal);
    deleteClose.addEventListener("click", closeModal);
    deleteCancel.addEventListener("click", closeModal);
    inputAllDay.addEventListener("change", toggleTimeInputs);

    modalForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const title = inputTitle.value.trim();
      const time = inputTime.value.trim();
      const endTime = inputEndTime.value.trim();
      const dateKey = inputStartDate.value || formatDateKey(new Date());
      const endDateKey = inputEndDate.value || dateKey;
      const allDay = inputAllDay.checked;
      const location = inputLocation.value.trim();
      const reminderRaw = inputReminder.value ? parseInt(inputReminder.value, 10) : null;
      // if blank/NaN, treat as no reminder
      const reminderMinutes = Number.isFinite(reminderRaw) ? reminderRaw : null;
      if (!title) return;
      if (window.chrome?.webview?.postMessage) {
        if (modalState.mode === "create") {
          window.chrome.webview.postMessage({ kind: "createEvent", title, time, endTime, dateKey, endDateKey, allDay, location, reminderMinutes });
        } else {
          window.chrome.webview.postMessage({ kind: "editEvent", id: modalState.id, title, time, endTime, dateKey, endDateKey, allDay, location, reminderMinutes });
        }
      } else {
        events[dateKey] = events[dateKey] || [];
        const existingIndex = events[dateKey].findIndex(e => e.id === modalState.id);
        const payload = { id: modalState.id || `${dateKey}-${title}-${Date.now()}`, title, time, endTime, endDateKey, allDay, startDateKey: dateKey, location, reminderMinutes, color: "#22d3ee" };
        if (modalState.mode === "edit" && existingIndex >= 0) {
          events[dateKey][existingIndex] = { ...events[dateKey][existingIndex], ...payload };
        } else {
          events[dateKey].push(payload);
        }
        renderCalendar();
        renderEventsSidebar(dateKey, state.current);
      }
      closeModal();
    });

    deleteConfirm.addEventListener("click", () => {
      if (window.chrome?.webview?.postMessage) {
        window.chrome.webview.postMessage({ kind: "deleteEvent", id: modalState.id });
      } else {
        Object.keys(events).forEach(key => {
          events[key] = (events[key] || []).filter(e => e.id !== modalState.id);
        });
        renderCalendar();
        renderEventsSidebar(state.selected ? formatDateKey(state.selected) : formatDateKey(new Date()), state.current);
      }
      closeModal();
    });

    renderWeekdays();
    renderCalendar();
  </script>
</body>
</html>
